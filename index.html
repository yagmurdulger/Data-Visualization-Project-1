<html>

<head>
  <meta charset="UTF-8">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!--Font from google fonts - can change later-->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mulish&display=swap" rel="stylesheet">
</head>

<body style="font-family:Mulish;">
  <h1>Project 1</h1>
  <div id="horizontal-bar-chart">
    <h3>Factors Affecting the Happiness Score of Countries:</h3>
    <svg id="horizontal-bar-chart" height="600" width="800"></svg>
    <script>
      const svg = d3.select('svg#horizontal-bar-chart');
      const w = svg.attr('width');
      const h = svg.attr('height');
      const margins = { top: 10, right: 10, bottom: 5, left: 125 };
      const width = w - margins.left - margins.right;
      const height = h - margins.top - margins.bottom;

      const getData = async function () {
        const data = await d3.csv('world_happiness.csv');
        const topbot10 = d3.filter(data, d => d.RANK <= 10 || d.RANK >= 137)
        console.log(topbot10)

        //Y axis - countries
        let countries = d3.map(topbot10, d => d.Country)
        const countryScale = d3.scaleBand()
          .paddingInner(0.20)
          .domain(countries)
          .range([0, height - (margins.bottom * 3)]);

        let leftAxis = d3.axisLeft(countryScale);

        //X axis - scores
        const scoreScale = d3.scaleLinear().domain([0, 7]).range([0, width]);

        let bottomAxis = d3.axisBottom(scoreScale);

        //Grab legend
        let keys = data.columns.slice(6);

        //Create colors for the different keys
        let colorScale = d3.scaleOrdinal()
          .range(["#a8e6cf", "#dcedc1", "#ffd3b6", "#ffaaa5", "#ff8b94", "#ffe1a8"]);

        //Bars
        svg.append("g").selectAll("g")
          .data(d3.stack().keys(keys)(topbot10))
          .join("g").attr("fill", d => colorScale(d.key)) //assign fill colors to the bars
          .selectAll("rect")
          .data(d => d)
          .join("rect")
          .attr('transform', `translate(${margins.left}, ${margins.top})`)
          .attr("x", d => scoreScale(d[0]))
          .attr("y", d => countryScale(d.data.Country))
          .attr("width", d => scoreScale(d[1]) - scoreScale(d[0]))
          .attr("height", countryScale.bandwidth());

        //show x and y axis
        svg.append("g").attr('transform', `translate(${margins.left}, ${margins.top})`).call(leftAxis);
        svg.append("g").attr('transform', `translate(${margins.left}, ${height - margins.bottom})`).call(bottomAxis);

        //show legend


        var legend = svg.append("g").selectAll("g")
          .data(keys.slice().reverse()).join("g")
          .attr('transform', (d, i) => `translate(${0}, ${height - (margins.bottom * 10) - (i * 20)})`);

        legend.append("rect")
          .attr("x", width - 50)
          .attr("width", 15)
          .attr("height", 15)
          .attr("fill", colorScale);

        legend.append("text")
          .attr("x", width - 25)
          .attr("y", 12)
          .style("font-size", "12px")
          .text(d => d);

        svg.append("text")
          .text("Happiness Score Explained By:")
          .attr("x", width - 50)
          .attr("y", height - (margins.bottom * 10) - (5.5 * 20))
          .style("font-size", "13px")
          .style("font-weight", "bolder");

        svg.append("line")
          .style("stroke", "grey")
          .style("stroke-width", "3px")
          .attr("x1", 0)
          .attr("y1", h / 2 - 20)
          .attr("x2", w)
          .attr("y2", h / 2 - 20);

        svg.append("text").text("Top 10").attr("text-anchor", "end")
          .attr("y", h / 2 - 20)
          .attr("x", w)
          .attr("dy", -15)
          .style("font-size", "16px")
          .style("font-weight", "bolder")
          .style("fill", "dark-grey");

        svg.append("text").text("Bottom 10").attr("text-anchor", "end")
          .attr("y", h / 2 - 20)
          .attr("x", w)
          .attr("dy", 25)
          .style("font-size", "16px")
          .style("font-weight", "bolder")
          .style("fill", "dark-grey");


      }



      getData();
    </script>
  </div>



  <div id="scatter-plot">

  </div>



</body>

</html>